<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Film Rating - Green Site</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Custom styles for eco-optimization */
    body { font-family: system-ui, sans-serif; }
    img { loading: lazy; max-width: 100px; } /* Lazy-loaded, compressed images */
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-green-600 text-white p-4">
    <h1 class="text-2xl font-bold">Green Film Rating</h1>
    <p class="text-sm">Eco-friendly movie rating platform (50% less energy than average sites)</p>
    <nav id="nav" class="mt-2">
      <a href="#" id="home-link" class="mr-4">Home</a>
      <a href="#" id="profile-link" class="mr-4 hidden">Profile</a>
      <a href="#" id="admin-link" class="mr-4 hidden">Admin</a>
      <a href="#" id="login-link" class="mr-4">Login</a>
      <a href="#" id="logout-link" class="hidden">Logout</a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto p-4">
    <!-- Home Section -->
    <section id="home" class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Welcome</h2>
      <p>This site lets you rate films, follow friends, and see community ratings, all while minimizing environmental impact.</p>
      <h3 class="text-lg font-semibold mt-4">Featured Films</h3>
      <div id="featured-films" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2"></div>
    </section>

    <!-- Login Section -->
    <section id="login" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Login</h2>
      <form id="login-form" class="space-y-4">
        <div>
          <label for="email" class="block">Email</label>
          <input type="email" id="email" class="w-full p-2 border rounded" required>
        </div>
        <div>
          <label for="password" class="block">Password</label>
          <input type="password" id="password" class="w-full p-2 border rounded" required>
        </div>
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Login</button>
      </form>
      <p class="mt-2">No account? <a href="#" id="show-register" class="text-green-600">Register</a></p>
    </section>

    <!-- Register Section -->
    <section id="register" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Register</h2>
      <form id="register-form" class="space-y-4">
        <div>
          <label for="name" class="block">Name</label>
          <input type="text" id="name" class="w-full p-2 border rounded" required>
        </div>
        <div>
          <label for="reg-email" class="block">Email</label>
          <input type="email" id="reg-email" class="w-full p-2 border rounded" required>
        </div>
        <div>
          <label for="reg-password" class="block">Password</label>
          <input type="password" id="reg-password" class="w-full p-2 border rounded" required>
        </div>
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Register</button>
      </form>
    </section>

    <!-- Profile Section -->
    <section id="profile" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Your Profile</h2>
      <div id="profile-info" class="mb-4"></div>
      <h3 class="text-lg font-semibold">Your Ratings</h3>
      <div id="user-ratings" class="mb-4"></div>
      <h3 class="text-lg font-semibold">Add Rating</h3>
      <form id="rating-form" class="space-y-4 mb-4">
        <div>
          <label for="film-id" class="block">Select Film</label>
          <select id="film-id" class="w-full p-2 border rounded" required>
            <option value="">Choose a film</option>
          </select>
        </div>
        <div>
          <label for="rating" class="block">Rating (1–5)</label>
          <input type="number" id="rating" class="w-full p-2 border rounded" min="1" max="5" required>
        </div>
        <div>
          <label for="review" class="block">Review (Optional)</label>
          <textarea id="review" class="w-full p-2 border rounded"></textarea>
        </div>
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Submit Rating</button>
      </form>
      <h3 class="text-lg font-semibold">Friends</h3>
      <div id="friends-list" class="mb-4"></div>
      <form id="add-friend-form" class="space-y-4">
        <div>
          <label for="friend-email" class="block">Friend’s Email</label>
          <input type="email" id="friend-email" class="w-full p-2 border rounded" required>
        </div>
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Add Friend</button>
      </form>
    </section>

    <!-- Admin Section -->
    <section id="admin" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-4">Admin - Manage Films</h2>
      <h3 class="text-lg font-semibold">Add Film</h3>
      <form id="add-film-form" class="space-y-4 mb-4">
        <div>
          <label for="film-title" class="block">Title</label>
          <input type="text" id="film-title" class="w-full p-2 border rounded" required>
        </div>
        <div>
          <label for="film-year" class="block">Year</label>
          <input type="number" id="film-year" class="w-full p-2 border rounded" min="1900" max="2025" required>
        </div>
        <button type="submit" class="bg-green-600 text-white p-2 rounded">Add Film</button>
      </form>
      <h3 class="text-lg font-semibold">Film List</h3>
      <div id="film-list" class="mb-4"></div>
    </section>
  </main>

  <script>
    // Minimal JavaScript for interactivity
    const apiUrl = 'http://localhost:3000/api';
    let token = localStorage.getItem('token');
    let userRole = null;

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    document.getElementById('home-link').addEventListener('click', () => showSection('home'));
    document.getElementById('login-link').addEventListener('click', () => showSection('login'));
    document.getElementById('profile-link').addEventListener('click', () => showSection('profile'));
    document.getElementById('admin-link').addEventListener('click', () => showSection('admin'));
    document.getElementById('show-register').addEventListener('click', () => showSection('register'));
    document.getElementById('logout-link').addEventListener('click', () => {
      localStorage.removeItem('token');
      token = null;
      userRole = null;
      updateNav();
      showSection('home');
    });

    function updateNav() {
      document.getElementById('login-link').classList.toggle('hidden', !!token);
      document.getElementById('profile-link').classList.toggle('hidden', !token);
      document.getElementById('logout-link').classList.toggle('hidden', !token);
      document.getElementById('admin-link').classList.toggle('hidden', !token || userRole !== 'admin');
    }

    // Fetch featured films
    async function loadFeaturedFilms() {
      try {
        const res = await fetch(`${apiUrl}/films/featured`);
        if (!res.ok) throw new Error(`Failed to fetch films: ${res.status}`);
        const films = await res.json();
        const container = document.getElementById('featured-films');
        container.innerHTML = films.map(f => `
          <div class="p-4 bg-white rounded shadow">
            <h4 class="font-semibold">${f.title} (${f.year})</h4>
            <p>Average Rating: ${f.avg_rating || 'N/A'}</p>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading featured films:', error);
      }
    }

    // Load films for rating dropdown
    async function loadFilmsForRating() {
      try {
        const res = await fetch(`${apiUrl}/films`);
        if (!res.ok) throw new Error(`Failed to fetch films: ${res.status}`);
        const films = await res.json();
        const select = document.getElementById('film-id');
        select.innerHTML = '<option value="">Choose a film</option>' + films.map(f => `
          <option value="${f.id}">${f.title} (${f.year})</option>
        `).join('');
      } catch (error) {
        console.error('Error loading films for rating:', error);
      }
    }

    // Login
    document.getElementById('login-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch(`${apiUrl}/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || `Login failed: ${res.status}`);
        }
        const data = await res.json();
        token = data.token;
        userRole = data.role;
        localStorage.setItem('token', token);
        updateNav();
        showSection('profile');
        await loadProfile();
        if (userRole === 'admin') await loadFilmsForAdmin();
        await loadFilmsForRating();
      } catch (error) {
        console.error('Error during login:', error);
        alert('Login failed: ' + error.message);
      }
    });

    // Register
    document.getElementById('register-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const name = document.getElementById('name').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const res = await fetch(`${apiUrl}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        if (!res.ok) throw new Error(`Registration failed: ${res.status}`);
        alert('Registered! Please login.');
        showSection('login');
      } catch (error) {
        console.error('Error during registration:', error);
        alert('Registration failed: ' + error.message);
      }
    });

    // Load Profile
    async function loadProfile() {
      try {
        // Load user info
        const userRes = await fetch(`${apiUrl}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!userRes.ok) throw new Error(`Failed to load user: ${userRes.status}`);
        const user = await userRes.json();
        document.getElementById('profile-info').innerHTML = `
          <p><strong>Name:</strong> ${user.name}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Role:</strong> ${user.role}</p>
        `;

        // Load ratings
        const ratingsRes = await fetch(`${apiUrl}/ratings/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!ratingsRes.ok) throw new Error(`Failed to load ratings: ${ratingsRes.status}`);
        const ratings = await ratingsRes.json();
        document.getElementById('user-ratings').innerHTML = ratings.length ? ratings.map(r => `
          <div class="p-2 bg-white rounded shadow mb-2">
            <p><strong>${r.film_title} (${r.film_year})</strong>: ${r.rating}/5</p>
            ${r.review ? `<p>${r.review}</p>` : ''}
            <button onclick="deleteRating(${r.id})" class="text-red-600 mt-1">Delete</button>
          </div>
        `).join('') : '<p>No ratings yet.</p>';

        // Load friends
        const friendsRes = await fetch(`${apiUrl}/friends`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!friendsRes.ok) throw new Error(`Failed to load friends: ${friendsRes.status}`);
        const friends = await friendsRes.json();
        document.getElementById('friends-list').innerHTML = friends.length ? friends.map(f => `
          <div class="p-2 bg-white rounded shadow mb-2">
            <p><strong>${f.name}</strong> (${f.email})</p>
            <button onclick="viewFriendRatings('${f.id}')" class="text-green-600">View Ratings</button>
          </div>
        `).join('') : '<p>No friends yet.</p>';
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('Failed to load profile: ' + error.message);
      }
    }

    // Add Rating
    document.getElementById('rating-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const filmId = document.getElementById('film-id').value;
        const rating = document.getElementById('rating').value;
        const review = document.getElementById('review').value;
        const res = await fetch(`${apiUrl}/ratings`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ film_id: filmId, rating, review })
        });
        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.message || `Failed to add rating: ${res.status}`);
        }
        document.getElementById('rating-form').reset();
        await loadProfile(); // Reload profile to update ratings
      } catch (error) {
        console.error('Error adding rating:', error);
        alert('Failed to add rating: ' + error.message);
      }
    });

    // Delete Rating
    async function deleteRating(ratingId) {
      try {
        if (confirm('Delete this rating?')) {
          const res = await fetch(`${apiUrl}/ratings/${ratingId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error(`Failed to delete rating: ${res.status}`);
          await loadProfile(); // Reload profile to update ratings
        }
      } catch (error) {
        console.error('Error deleting rating:', error);
        alert('Failed to delete rating: ' + error.message);
      }
    }

    // Add Friend
    document.getElementById('add-friend-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const email = document.getElementById('friend-email').value;
        const res = await fetch(`${apiUrl}/friends`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        if (!res.ok) throw new Error(`Failed to add friend: ${res.status}`);
        document.getElementById('add-friend-form').reset();
        await loadProfile(); // Reload profile to update friends
      } catch (error) {
        console.error('Error adding friend:', error);
        alert('Failed to add friend: ' + error.message);
      }
    });

    // View Friend Ratings
    async function viewFriendRatings(friendId) {
      try {
        const res = await fetch(`${apiUrl}/ratings/friend/${friendId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`Failed to load friend ratings: ${res.status}`);
        const ratings = await res.json();
        alert(ratings.map(r => `${r.film_title} (${r.film_year}): ${r.rating}/5`).join('\n'));
      } catch (error) {
        console.error('Error viewing friend ratings:', error);
        alert('Failed to view friend ratings: ' + error.message);
      }
    }

    // Admin: Load Films
    async function loadFilmsForAdmin() {
      try {
        const res = await fetch(`${apiUrl}/films`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`Failed to fetch films: ${res.status}`);
        const films = await res.json();
        const container = document.getElementById('film-list');
        container.innerHTML = films.map(f => `
          <div class="p-4 bg-white rounded shadow mb-2">
            <p><strong>${f.title} (${f.year})</strong></p>
            <button onclick="updateFilm(${f.id}, '${f.title}', ${f.year})" class="text-green-600 mr-2">Edit</button>
            <button onclick="deleteFilm(${f.id})" class="text-red-600">Delete</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading films for admin:', error);
      }
    }

    // Admin: Add Film
    document.getElementById('add-film-form').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const title = document.getElementById('film-title').value;
        const year = document.getElementById('film-year').value;
        const res = await fetch(`${apiUrl}/films`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, year })
        });
        if (!res.ok) throw new Error(`Failed to add film: ${res.status}`);
        document.getElementById('add-film-form').reset();
        await loadFilmsForAdmin();
        await loadFilmsForRating();
      } catch (error) {
        console.error('Error adding film:', error);
        alert('Failed to add film: ' + error.message);
      }
    });

    // Admin: Update Film
    async function updateFilm(id, title, year) {
      try {
        const newTitle = prompt('Enter new title:', title);
        const newYear = prompt('Enter new year:', year);
        if (newTitle && newYear) {
          const res = await fetch(`${apiUrl}/films/${id}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle, year: newYear })
          });
          if (!res.ok) throw new Error(`Failed to update film: ${res.status}`);
          await loadFilmsForAdmin();
          await loadFilmsForRating();
        }
      } catch (error) {
        console.error('Error updating film:', error);
        alert('Failed to update film: ' + error.message);
      }
    }

    // Admin: Delete Film
    async function deleteFilm(id) {
      try {
        if (confirm('Delete this film?')) {
          const res = await fetch(`${apiUrl}/films/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error(`Failed to delete film: ${res.status}`);
          await loadFilmsForAdmin();
          await loadFilmsForRating();
        }
      } catch (error) {
        console.error('Error deleting film:', error);
        alert('Failed to delete film: ' + error.message);
      }
    }

    // Initial Load
    updateNav();
    loadFeaturedFilms();
    if (token) {
      fetch(`${apiUrl}/users/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => {
          if (!res.ok) throw new Error(`Failed to load user: ${res.status}`);
          return res.json();
        })
        .then(user => {
          userRole = user.role;
          updateNav();
          if (userRole === 'admin') loadFilmsForAdmin();
          loadFilmsForRating();
          loadProfile();
        })
        .catch(error => {
          console.error('Error during initial load:', error);
          localStorage.removeItem('token');
          token = null;
          updateNav();
        });
    }
  </script>
</body>
</html>